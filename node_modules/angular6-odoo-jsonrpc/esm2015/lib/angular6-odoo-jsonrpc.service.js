/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { Inject, Injectable } from '@angular/core';
import { HttpClient, HttpHeaders } from '@angular/common/http';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
class Cookies {
    constructor() {
        this.session_id = null;
    }
    /**
     * @return {?}
     */
    delete_sessionId() {
        this.session_id = null;
        document.cookie = 'session_id=; expires=Wed, 29 Jun 2016 00:00:00 UTC';
    }
    /**
     * @return {?}
     */
    get_sessionId() {
        return document
            .cookie.split('; ')
            .filter(x => x.indexOf('session_id') === 0)
            .map(x => x.split('=')[1])
            .pop() || this.session_id || '';
    }
    /**
     * @param {?} val
     * @return {?}
     */
    set_sessionId(val) {
        document.cookie = `session_id=${val}`;
        this.session_id = val;
    }
}
function Cookies_tsickle_Closure_declarations() {
    /** @type {?} */
    Cookies.prototype.session_id;
}
export class Ng6OdooRPCService {
    /**
     * @param {?} http
     */
    constructor(http) {
        this.http = http;
        this.uniq_id_counter = 0;
        this.shouldManageSessionId = false;
        this.context = JSON.parse(localStorage.getItem('user_context')) || { 'lang': 'en_US' };
        this.cookies = new Cookies();
    }
    /**
     * @param {?} configs
     * @return {?}
     */
    init(configs) {
        this.odoo_server = configs.odoo_server;
        this.http_auth = configs.http_auth || null;
    }
    /**
     * @param {?} odoo_server
     * @return {?}
     */
    setOdooServer(odoo_server) {
        this.odoo_server = odoo_server;
    }
    /**
     * @param {?} http_auth
     * @return {?}
     */
    setHttpAuth(http_auth) {
        this.http_auth = http_auth;
    }
    /**
     * @param {?} url
     * @param {?} params
     * @return {?}
     */
    sendRequest(url, params) {
        const /** @type {?} */ body = this.buildRequest(url, params);
        return this.http.post(this.odoo_server + url, body, { headers: this.headers })
            .toPromise()
            .then(this.handleOdooErrors)
            .catch(this.handleHttpErrors);
    }
    /**
     * @return {?}
     */
    getServerInfo() {
        return this.sendRequest('/web/webclient/version_info', {});
    }
    /**
     * @return {?}
     */
    getSessionInfo() {
        return this.sendRequest('/web/session/get_session_info', {});
    }
    /**
     * @param {?} db
     * @param {?} login
     * @param {?} password
     * @return {?}
     */
    login(db, login, password) {
        const /** @type {?} */ params = {
            db: db,
            login: login,
            password: password
        };
        const /** @type {?} */ $this = this;
        return this.sendRequest('/web/session/authenticate', params).then(function (result) {
            if (!result.uid) {
                $this.cookies.delete_sessionId();
                return Promise.reject({
                    title: 'wrong_login',
                    message: 'Username and password don\'t match',
                    fullTrace: result
                });
            }
            $this.context = result.user_context;
            localStorage.setItem('user_context', JSON.stringify($this.context));
            $this.cookies.set_sessionId(result.session_id);
            return result;
        });
    }
    /**
     * @param {?=} force
     * @return {?}
     */
    isLoggedIn(force = true) {
        if (!force) {
            return Promise.resolve(this.cookies.get_sessionId().length > 0);
        }
        return this.getSessionInfo().then((result) => {
            this.cookies.set_sessionId(result.session_id);
            return !!(result.uid);
        });
    }
    /**
     * @param {?=} force
     * @return {?}
     */
    logout(force = true) {
        this.cookies.delete_sessionId();
        if (force) {
            return this.getSessionInfo().then((r) => {
                // get db from sessionInfo
                if (r.db) {
                    return this.login(r.db, '', '');
                }
            });
        }
        else {
            return Promise.resolve();
        }
    }
    /**
     * @return {?}
     */
    getDbList() {
        // only use for odoo < 9.0
        return this.sendRequest('/web/database/get_list', {});
    }
    /**
     * @param {?} model
     * @param {?} domain
     * @param {?} fields
     * @param {?} limit
     * @param {?} offset
     * @param {?=} context
     * @param {?=} sort
     * @return {?}
     */
    searchRead(model, domain, fields, limit, offset, context = {}, sort) {
        const /** @type {?} */ params = {
            model: model,
            domain: domain,
            fields: fields,
            limit: limit,
            offset: offset,
            context: context || this.context,
            sort: sort || ''
        };
        return this.sendRequest('/web/dataset/search_read', params);
    }
    /**
     * @param {?} context
     * @return {?}
     */
    updateContext(context) {
        localStorage.setItem('user_context', JSON.stringify(context));
        const /** @type {?} */ args = [[(/** @type {?} */ (this.context)).uid], context];
        this.call('res.users', 'write', args, {})
            .then(() => this.context = context)
            .catch((err) => this.context = context);
    }
    /**
     * @return {?}
     */
    getContext() {
        return this.context;
    }
    /**
     * @return {?}
     */
    getServer() {
        return this.odoo_server;
    }
    /**
     * @param {?} model
     * @param {?} method
     * @param {?} args
     * @param {?} kwargs
     * @return {?}
     */
    call(model, method, args, kwargs) {
        kwargs = kwargs || {};
        kwargs.context = kwargs.context || {};
        (/** @type {?} */ (Object)).assign(kwargs.context, this.context);
        const /** @type {?} */ params = {
            model: model,
            method: method,
            args: args,
            kwargs: kwargs,
        };
        return this.sendRequest('/web/dataset/call_kw', params);
    }
    /**
     * @param {?} url
     * @param {?} params
     * @return {?}
     */
    buildRequest(url, params) {
        this.uniq_id_counter += 1;
        if (this.shouldManageSessionId) {
            params.session_id = this.cookies.get_sessionId();
        }
        this.headers = new HttpHeaders({
            'Content-Type': 'application/json',
            'X-Openerp-Session-Id': this.cookies.get_sessionId(),
            'Authorization': 'Basic ' + btoa(`${this.http_auth}`)
        });
        return JSON.stringify({
            jsonrpc: '2.0',
            method: 'call',
            params: params,
        });
    }
    /**
     * @param {?} response
     * @return {?}
     */
    handleOdooErrors(response) {
        if (!response.error) {
            return response.result;
        }
        const /** @type {?} */ error = response.error;
        const /** @type {?} */ errorObj = {
            title: '    ',
            message: '',
            fullTrace: error
        };
        if (error.code === 200 && error.message === 'Odoo Server Error' && error.data.name === 'werkzeug.exceptions.NotFound') {
            errorObj.title = 'page_not_found';
            errorObj.message = 'HTTP Error';
        }
        else if ((error.code === 100 && error.message === 'Odoo Session Expired') || // v8
            // v8
            (error.code === 300 && error.message === 'OpenERP WebClient Error' && error.data.debug.match('SessionExpiredException')) // v7
        ) {
            errorObj.title = 'session_expired';
            this.cookies.delete_sessionId();
        }
        else if ((error.message === 'Odoo Server Error' && /FATAL:  database "(.+)" does not exist/.test(error.data.message))) {
            errorObj.title = 'database_not_found';
            errorObj.message = error.data.message;
        }
        else if ((error.data.name === 'openerp.exceptions.AccessError')) {
            errorObj.title = 'AccessError';
            errorObj.message = error.data.message;
        }
        else {
            const /** @type {?} */ split = ('' + error.data.fault_code).split('\n')[0].split(' -- ');
            if (split.length > 1) {
                error.type = split.shift();
                error.data.fault_code = error.data.fault_code.substr(error.type.length + 4);
            }
            if (error.code === 200 && error.type) {
                errorObj.title = error.type;
                errorObj.message = error.data.fault_code.replace(/\n/g, '<br />');
            }
            else {
                errorObj.title = error.message;
                errorObj.message = error.data.debug.replace(/\n/g, '<br />');
            }
        }
        return Promise.reject(errorObj);
    }
    /**
     * @param {?} error
     * @return {?}
     */
    handleHttpErrors(error) {
        return Promise.reject(error.message || error);
    }
}
Ng6OdooRPCService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] },
];
/** @nocollapse */
Ng6OdooRPCService.ctorParameters = () => [
    { type: HttpClient, decorators: [{ type: Inject, args: [HttpClient,] }] }
];
/** @nocollapse */ Ng6OdooRPCService.ngInjectableDef = i0.defineInjectable({ factory: function Ng6OdooRPCService_Factory() { return new Ng6OdooRPCService(i0.inject(i1.HttpClient)); }, token: Ng6OdooRPCService, providedIn: "root" });
function Ng6OdooRPCService_tsickle_Closure_declarations() {
    /** @type {?} */
    Ng6OdooRPCService.prototype.cookies;
    /** @type {?} */
    Ng6OdooRPCService.prototype.uniq_id_counter;
    /** @type {?} */
    Ng6OdooRPCService.prototype.shouldManageSessionId;
    /** @type {?} */
    Ng6OdooRPCService.prototype.context;
    /** @type {?} */
    Ng6OdooRPCService.prototype.headers;
    /** @type {?} */
    Ng6OdooRPCService.prototype.http_auth;
    /** @type {?} */
    Ng6OdooRPCService.prototype.odoo_server;
    /** @type {?} */
    Ng6OdooRPCService.prototype.http;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5ndWxhcjYtb2Rvby1qc29ucnBjLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9hbmd1bGFyNi1vZG9vLWpzb25ycGMvIiwic291cmNlcyI6WyJsaWIvYW5ndWxhcjYtb2Rvby1qc29ucnBjLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBQyxNQUFNLEVBQUUsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ2pELE9BQU8sRUFBQyxVQUFVLEVBQUUsV0FBVyxFQUFDLE1BQU0sc0JBQXNCLENBQUM7OztBQUU3RDs7MEJBQytCLElBQUk7Ozs7O0lBRWpDLGdCQUFnQjtRQUNkLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1FBQ3ZCLFFBQVEsQ0FBQyxNQUFNLEdBQUcsb0RBQW9ELENBQUM7S0FDeEU7Ozs7SUFFRCxhQUFhO1FBQ1gsTUFBTSxDQUFDLFFBQVE7YUFDWixNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQzthQUNsQixNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUMxQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ3pCLEdBQUcsRUFBRSxJQUFJLElBQUksQ0FBQyxVQUFVLElBQUksRUFBRSxDQUFDO0tBQ25DOzs7OztJQUVELGFBQWEsQ0FBQyxHQUFXO1FBQ3ZCLFFBQVEsQ0FBQyxNQUFNLEdBQUcsY0FBYyxHQUFHLEVBQUUsQ0FBQztRQUN0QyxJQUFJLENBQUMsVUFBVSxHQUFHLEdBQUcsQ0FBQztLQUN2QjtDQUNGOzs7OztBQU1ELE1BQU07Ozs7SUFTSixZQUM4QixJQUFnQjtRQUFoQixTQUFJLEdBQUosSUFBSSxDQUFZOytCQVJwQixDQUFDO3FDQUNLLEtBQUs7dUJBQ1gsSUFBSSxD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QUM7Ozs7OztJQUcxQixnQkFBZ0IsQ0FBQyxLQUFVO1FBQ2pDLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLElBQUksS0FBSyxDQUFDLENBQUM7Ozs7WUEzTWpELFVBQVUsU0FBQztnQkFDVixVQUFVLEVBQUUsTUFBTTthQUNuQjs7OztZQTNCTyxVQUFVLHVCQXNDYixNQUFNLFNBQUMsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SW5qZWN0LCBJbmplY3RhYmxlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7SHR0cENsaWVudCwgSHR0cEhlYWRlcnN9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcblxuY2xhc3MgQ29va2llcyB7IC8vIGNvb2tpZXMgZG9lc24ndCB3b3JrIHdpdGggQW5kcm9pZCBkZWZhdWx0IGJyb3dzZXIgLyBJb25pY1xuICBwcml2YXRlIHNlc3Npb25faWQ6IHN0cmluZyA9IG51bGw7XG5cbiAgZGVsZXRlX3Nlc3Npb25JZCgpIHtcbiAgICB0aGlzLnNlc3Npb25faWQgPSBudWxsO1xuICAgIGRvY3VtZW50LmNvb2tpZSA9ICdzZXNzaW9uX2lkPTsgZXhwaXJlcz1XZWQsIDI5IEp1biAyMDE2IDAwOjAwOjAwIFVUQyc7XG4gIH1cblxuICBnZXRfc2Vzc2lvbklkKCkge1xuICAgIHJldHVybiBkb2N1bWVudFxuICAgICAgLmNvb2tpZS5zcGxpdCgnOyAnKVxuICAgICAgLmZpbHRlcih4ID0+IHguaW5kZXhPZignc2Vzc2lvbl9pZCcpID09PSAwKVxuICAgICAgLm1hcCh4ID0+IHguc3BsaXQoJz0nKVsxXSlcbiAgICAgIC5wb3AoKSB8fCB0aGlzLnNlc3Npb25faWQgfHwgJyc7XG4gIH1cblxuICBzZXRfc2Vzc2lvbklkKHZhbDogc3RyaW5nKSB7XG4gICAgZG9jdW1lbnQuY29va2llID0gYHNlc3Npb25faWQ9JHt2YWx9YDtcbiAgICB0aGlzLnNlc3Npb25faWQgPSB2YWw7XG4gIH1cbn1cblxuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBOZzZPZG9vUlBDU2VydmljZSB7XG4gIHByaXZhdGUgY29va2llczogQ29va2llcztcbiAgcHJpdmF0ZSB1bmlxX2lkX2NvdW50ZXIgPSAwO1xuICBwcml2YXRlIHNob3VsZE1hbmFnZVNlc3Npb25JZCA9IGZhbHNlOyAvLyB0cnkgd2l0aG91dCBmaXJzdFxuICBwcml2YXRlIGNvbnRleHQ6IE9iamVjdCA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3VzZXJfY29udGV4dCcpKSB8fCB7J2xhbmcnOiAnZW5fVVMnfTtcbiAgcHJpdmF0ZSBoZWFkZXJzOiBIdHRwSGVhZGVycztcbiAgcHJpdmF0ZSBodHRwX2F1dGg6IHN0cmluZztcbiAgcHJpdmF0ZSBvZG9vX3NlcnZlcjogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3QoSHR0cENsaWVudCkgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50KSB7XG4gICAgdGhpcy5jb29raWVzID0gbmV3IENvb2tpZXMoKTtcbiAgfVxuXG4gIHB1YmxpYyBpbml0KGNvbmZpZ3M6IGFueSkge1xuICAgIHRoaXMub2Rvb19zZXJ2ZXIgPSBjb25maWdzLm9kb29fc2VydmVyO1xuICAgIHRoaXMuaHR0cF9hdXRoID0gY29uZmlncy5odHRwX2F1dGggfHwgbnVsbDtcbiAgfVxuXG4gIHB1YmxpYyBzZXRPZG9vU2VydmVyKG9kb29fc2VydmVyOiBzdHJpbmcpIHtcbiAgICB0aGlzLm9kb29fc2VydmVyID0gb2Rvb19zZXJ2ZXI7XG4gIH1cblxuICBwdWJsaWMgc2V0SHR0cEF1dGgoaHR0cF9hdXRoOiBzdHJpbmcpIHtcbiAgICB0aGlzLmh0dHBfYXV0aCA9IGh0dHBfYXV0aDtcbiAgfVxuXG4gIHB1YmxpYyBzZW5kUmVxdWVzdCh1cmw6IHN0cmluZywgcGFyYW1zOiBPYmplY3QpOiBQcm9taXNlPGFueT4ge1xuICAgIGNvbnN0IGJvZHkgPSB0aGlzLmJ1aWxkUmVxdWVzdCh1cmwsIHBhcmFtcyk7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5wb3N0KHRoaXMub2Rvb19zZXJ2ZXIgKyB1cmwsIGJvZHksIHtoZWFkZXJzOiB0aGlzLmhlYWRlcnN9KVxuICAgICAgLnRvUHJvbWlzZSgpXG4gICAgICAudGhlbih0aGlzLmhhbmRsZU9kb29FcnJvcnMpXG4gICAgICAuY2F0Y2godGhpcy5oYW5kbGVIdHRwRXJyb3JzKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRTZXJ2ZXJJbmZvKCkge1xuICAgIHJldHVybiB0aGlzLnNlbmRSZXF1ZXN0KCcvd2ViL3dlYmNsaWVudC92ZXJzaW9uX2luZm8nLCB7fSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0U2Vzc2lvbkluZm8oKSB7XG4gICAgcmV0dXJuIHRoaXMuc2VuZFJlcXVlc3QoJy93ZWIvc2Vzc2lvbi9nZXRfc2Vzc2lvbl9pbmZvJywge30pO1xuICB9XG5cbiAgcHVibGljIGxvZ2luKGRiOiBzdHJpbmcsIGxvZ2luOiBzdHJpbmcsIHBhc3N3b3JkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBwYXJhbXMgPSB7XG4gICAgICBkYjogZGIsXG4gICAgICBsb2dpbjogbG9naW4sXG4gICAgICBwYXNzd29yZDogcGFzc3dvcmRcbiAgICB9O1xuICAgIGNvbnN0ICR0aGlzID0gdGhpcztcbiAgICByZXR1cm4gdGhpcy5zZW5kUmVxdWVzdCgnL3dlYi9zZXNzaW9uL2F1dGhlbnRpY2F0ZScsIHBhcmFtcykudGhlbihmdW5jdGlvbiAocmVzdWx0OiBhbnkpIHtcbiAgICAgIGlmICghcmVzdWx0LnVpZCkge1xuICAgICAgICAkdGhpcy5jb29raWVzLmRlbGV0ZV9zZXNzaW9uSWQoKTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KHtcbiAgICAgICAgICB0aXRsZTogJ3dyb25nX2xvZ2luJyxcbiAgICAgICAgICBtZXNzYWdlOiAnVXNlcm5hbWUgYW5kIHBhc3N3b3JkIGRvblxcJ3QgbWF0Y2gnLFxuICAgICAgICAgIGZ1bGxUcmFjZTogcmVzdWx0XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgJHRoaXMuY29udGV4dCA9IHJlc3VsdC51c2VyX2NvbnRleHQ7XG4gICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgndXNlcl9jb250ZXh0JywgSlNPTi5zdHJpbmdpZnkoJHRoaXMuY29udGV4dCkpO1xuICAgICAgJHRoaXMuY29va2llcy5zZXRfc2Vzc2lvbklkKHJlc3VsdC5zZXNzaW9uX2lkKTtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgaXNMb2dnZWRJbihmb3JjZTogYm9vbGVhbiA9IHRydWUpIHtcbiAgICBpZiAoIWZvcmNlKSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMuY29va2llcy5nZXRfc2Vzc2lvbklkKCkubGVuZ3RoID4gMCk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmdldFNlc3Npb25JbmZvKCkudGhlbigocmVzdWx0OiBhbnkpID0+IHtcbiAgICAgIHRoaXMuY29va2llcy5zZXRfc2Vzc2lvbklkKHJlc3VsdC5zZXNzaW9uX2lkKTtcbiAgICAgIHJldHVybiAhIShyZXN1bHQudWlkKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBsb2dvdXQoZm9yY2U6IGJvb2xlYW4gPSB0cnVlKSB7XG4gICAgdGhpcy5jb29raWVzLmRlbGV0ZV9zZXNzaW9uSWQoKTtcbiAgICBpZiAoZm9yY2UpIHtcbiAgICAgIHJldHVybiB0aGlzLmdldFNlc3Npb25JbmZvKCkudGhlbigocjogYW55KSA9PiB7IC8vIGdldCBkYiBmcm9tIHNlc3Npb25JbmZvXG4gICAgICAgIGlmIChyLmRiKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMubG9naW4oci5kYiwgJycsICcnKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZ2V0RGJMaXN0KCkgeyAvLyBvbmx5IHVzZSBmb3Igb2RvbyA8IDkuMFxuICAgIHJldHVybiB0aGlzLnNlbmRSZXF1ZXN0KCcvd2ViL2RhdGFiYXNlL2dldF9saXN0Jywge30pO1xuICB9XG5cbiAgcHVibGljIHNlYXJjaFJlYWQobW9kZWw6IHN0cmluZywgZG9tYWluOiBhbnksIGZpZWxkczogYW55LCBsaW1pdDogbnVtYmVyLCBvZmZzZXQ6IG51bWJlciwgY29udGV4dDogYW55ID0ge30sIHNvcnQ/OiBzdHJpbmcpIHtcbiAgICBjb25zdCBwYXJhbXMgPSB7XG4gICAgICBtb2RlbDogbW9kZWwsXG4gICAgICBkb21haW46IGRvbWFpbixcbiAgICAgIGZpZWxkczogZmllbGRzLFxuICAgICAgbGltaXQ6IGxpbWl0LFxuICAgICAgb2Zmc2V0OiBvZmZzZXQsXG4gICAgICBjb250ZXh0OiBjb250ZXh0IHx8IHRoaXMuY29udGV4dCxcbiAgICAgIHNvcnQ6IHNvcnQgfHwgJydcbiAgICB9O1xuICAgIHJldHVybiB0aGlzLnNlbmRSZXF1ZXN0KCcvd2ViL2RhdGFzZXQvc2VhcmNoX3JlYWQnLCBwYXJhbXMpO1xuICB9XG5cbiAgcHVibGljIHVwZGF0ZUNvbnRleHQoY29udGV4dDogYW55KSB7XG4gICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ3VzZXJfY29udGV4dCcsIEpTT04uc3RyaW5naWZ5KGNvbnRleHQpKTtcbiAgICBjb25zdCBhcmdzID0gW1soPGFueT50aGlzLmNvbnRleHQpLnVpZF0sIGNvbnRleHRdO1xuICAgIHRoaXMuY2FsbCgncmVzLnVzZXJzJywgJ3dyaXRlJywgYXJncywge30pXG4gICAgICAudGhlbigoKSA9PiB0aGlzLmNvbnRleHQgPSBjb250ZXh0KVxuICAgICAgLmNhdGNoKChlcnI6IGFueSkgPT4gdGhpcy5jb250ZXh0ID0gY29udGV4dCk7XG4gIH1cblxuICBwdWJsaWMgZ2V0Q29udGV4dCgpIHtcbiAgICByZXR1cm4gdGhpcy5jb250ZXh0O1xuICB9XG5cbiAgcHVibGljIGdldFNlcnZlcigpIHtcbiAgICByZXR1cm4gdGhpcy5vZG9vX3NlcnZlcjtcbiAgfVxuXG4gIHB1YmxpYyBjYWxsKG1vZGVsOiBzdHJpbmcsIG1ldGhvZDogc3RyaW5nLCBhcmdzOiBhbnksIGt3YXJnczogYW55KSB7XG5cbiAgICBrd2FyZ3MgPSBrd2FyZ3MgfHwge307XG4gICAga3dhcmdzLmNvbnRleHQgPSBrd2FyZ3MuY29udGV4dCB8fCB7fTtcbiAgICAoPGFueT5PYmplY3QpLmFzc2lnbihrd2FyZ3MuY29udGV4dCwgdGhpcy5jb250ZXh0KTtcblxuICAgIGNvbnN0IHBhcmFtcyA9IHtcbiAgICAgIG1vZGVsOiBtb2RlbCxcbiAgICAgIG1ldGhvZDogbWV0aG9kLFxuICAgICAgYXJnczogYXJncyxcbiAgICAgIGt3YXJnczoga3dhcmdzLFxuICAgIH07XG4gICAgcmV0dXJuIHRoaXMuc2VuZFJlcXVlc3QoJy93ZWIvZGF0YXNldC9jYWxsX2t3JywgcGFyYW1zKTtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRSZXF1ZXN0KHVybDogc3RyaW5nLCBwYXJhbXM6IGFueSkge1xuICAgIHRoaXMudW5pcV9pZF9jb3VudGVyICs9IDE7XG4gICAgaWYgKHRoaXMuc2hvdWxkTWFuYWdlU2Vzc2lvbklkKSB7XG4gICAgICBwYXJhbXMuc2Vzc2lvbl9pZCA9IHRoaXMuY29va2llcy5nZXRfc2Vzc2lvbklkKCk7XG4gICAgfVxuXG4gICAgdGhpcy5oZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKHtcbiAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAnWC1PcGVuZXJwLVNlc3Npb24tSWQnOiB0aGlzLmNvb2tpZXMuZ2V0X3Nlc3Npb25JZCgpLFxuICAgICAgJ0F1dGhvcml6YXRpb24nOiAnQmFzaWMgJyArIGJ0b2EoYCR7dGhpcy5odHRwX2F1dGh9YClcbiAgICB9KTtcbiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoe1xuICAgICAganNvbnJwYzogJzIuMCcsXG4gICAgICBtZXRob2Q6ICdjYWxsJyxcbiAgICAgIHBhcmFtczogcGFyYW1zLCAvLyBwYXlsb2FkXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZU9kb29FcnJvcnMocmVzcG9uc2U6IGFueSkge1xuICAgIGlmICghcmVzcG9uc2UuZXJyb3IpIHtcbiAgICAgIHJldHVybiByZXNwb25zZS5yZXN1bHQ7XG4gICAgfVxuXG4gICAgY29uc3QgZXJyb3IgPSByZXNwb25zZS5lcnJvcjtcbiAgICBjb25zdCBlcnJvck9iaiA9IHtcbiAgICAgIHRpdGxlOiAnICAgICcsXG4gICAgICBtZXNzYWdlOiAnJyxcbiAgICAgIGZ1bGxUcmFjZTogZXJyb3JcbiAgICB9O1xuXG4gICAgaWYgKGVycm9yLmNvZGUgPT09IDIwMCAmJiBlcnJvci5tZXNzYWdlID09PSAnT2RvbyBTZXJ2ZXIgRXJyb3InICYmIGVycm9yLmRhdGEubmFtZSA9PT0gJ3dlcmt6ZXVnLmV4Y2VwdGlvbnMuTm90Rm91bmQnKSB7XG4gICAgICBlcnJvck9iai50aXRsZSA9ICdwYWdlX25vdF9mb3VuZCc7XG4gICAgICBlcnJvck9iai5tZXNzYWdlID0gJ0hUVFAgRXJyb3InO1xuICAgIH0gZWxzZSBpZiAoKGVycm9yLmNvZGUgPT09IDEwMCAmJiBlcnJvci5tZXNzYWdlID09PSAnT2RvbyBTZXNzaW9uIEV4cGlyZWQnKSB8fCAvLyB2OFxuICAgICAgKGVycm9yLmNvZGUgPT09IDMwMCAmJiBlcnJvci5tZXNzYWdlID09PSAnT3BlbkVSUCBXZWJDbGllbnQgRXJyb3InICYmIGVycm9yLmRhdGEuZGVidWcubWF0Y2goJ1Nlc3Npb25FeHBpcmVkRXhjZXB0aW9uJykpIC8vIHY3XG4gICAgKSB7XG4gICAgICBlcnJvck9iai50aXRsZSA9ICdzZXNzaW9uX2V4cGlyZWQnO1xuICAgICAgdGhpcy5jb29raWVzLmRlbGV0ZV9zZXNzaW9uSWQoKTtcbiAgICB9IGVsc2UgaWYgKChlcnJvci5tZXNzYWdlID09PSAnT2RvbyBTZXJ2ZXIgRXJyb3InICYmIC9GQVRBTDogIGRhdGFiYXNlIFwiKC4rKVwiIGRvZXMgbm90IGV4aXN0Ly50ZXN0KGVycm9yLmRhdGEubWVzc2FnZSkpKSB7XG4gICAgICBlcnJvck9iai50aXRsZSA9ICdkYXRhYmFzZV9ub3RfZm91bmQnO1xuICAgICAgZXJyb3JPYmoubWVzc2FnZSA9IGVycm9yLmRhdGEubWVzc2FnZTtcbiAgICB9IGVsc2UgaWYgKChlcnJvci5kYXRhLm5hbWUgPT09ICdvcGVuZXJwLmV4Y2VwdGlvbnMuQWNjZXNzRXJyb3InKSkge1xuICAgICAgZXJyb3JPYmoudGl0bGUgPSAnQWNjZXNzRXJyb3InO1xuICAgICAgZXJyb3JPYmoubWVzc2FnZSA9IGVycm9yLmRhdGEubWVzc2FnZTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3Qgc3BsaXQgPSAoJycgKyBlcnJvci5kYXRhLmZhdWx0X2NvZGUpLnNwbGl0KCdcXG4nKVswXS5zcGxpdCgnIC0tICcpO1xuICAgICAgaWYgKHNwbGl0Lmxlbmd0aCA+IDEpIHtcbiAgICAgICAgZXJyb3IudHlwZSA9IHNwbGl0LnNoaWZ0KCk7XG4gICAgICAgIGVycm9yLmRhdGEuZmF1bHRfY29kZSA9IGVycm9yLmRhdGEuZmF1bHRfY29kZS5zdWJzdHIoZXJyb3IudHlwZS5sZW5ndGggKyA0KTtcbiAgICAgIH1cblxuICAgICAgaWYgKGVycm9yLmNvZGUgPT09IDIwMCAmJiBlcnJvci50eXBlKSB7XG4gICAgICAgIGVycm9yT2JqLnRpdGxlID0gZXJyb3IudHlwZTtcbiAgICAgICAgZXJyb3JPYmoubWVzc2FnZSA9IGVycm9yLmRhdGEuZmF1bHRfY29kZS5yZXBsYWNlKC9cXG4vZywgJzxiciAvPicpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZXJyb3JPYmoudGl0bGUgPSBlcnJvci5tZXNzYWdlO1xuICAgICAgICBlcnJvck9iai5tZXNzYWdlID0gZXJyb3IuZGF0YS5kZWJ1Zy5yZXBsYWNlKC9cXG4vZywgJzxiciAvPicpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyb3JPYmopO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVIdHRwRXJyb3JzKGVycm9yOiBhbnkpIHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyb3IubWVzc2FnZSB8fCBlcnJvcik7XG4gIH1cblxufVxuIl19