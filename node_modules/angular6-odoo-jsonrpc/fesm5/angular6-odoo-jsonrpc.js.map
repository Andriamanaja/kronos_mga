{"version":3,"file":"angular6-odoo-jsonrpc.js.map","sources":["ng://angular6-odoo-jsonrpc/lib/angular6-odoo-jsonrpc.service.ts","ng://angular6-odoo-jsonrpc/lib/angular6-odoo-jsonrpc.module.ts"],"sourcesContent":["import {Inject, Injectable} from '@angular/core';\nimport {HttpClient, HttpHeaders} from '@angular/common/http';\n\nclass Cookies { // cookies doesn't work with Android default browser / Ionic\n  private session_id: string = null;\n\n  delete_sessionId() {\n    this.session_id = null;\n    document.cookie = 'session_id=; expires=Wed, 29 Jun 2016 00:00:00 UTC';\n  }\n\n  get_sessionId() {\n    return document\n      .cookie.split('; ')\n      .filter(x => x.indexOf('session_id') === 0)\n      .map(x => x.split('=')[1])\n      .pop() || this.session_id || '';\n  }\n\n  set_sessionId(val: string) {\n    document.cookie = `session_id=${val}`;\n    this.session_id = val;\n  }\n}\n\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class Ng6OdooRPCService {\n  private cookies: Cookies;\n  private uniq_id_counter = 0;\n  private shouldManageSessionId = false; // try without first\n  private context: Object = JSON.parse(localStorage.getItem('user_context')) || {'lang': 'en_US'};\n  private headers: HttpHeaders;\n  private http_auth: string;\n  private odoo_server: string;\n\n  constructor(\n    @Inject(HttpClient) private http: HttpClient) {\n    this.cookies = new Cookies();\n  }\n\n  public init(configs: any) {\n    this.odoo_server = configs.odoo_server;\n    this.http_auth = configs.http_auth || null;\n  }\n\n  public setOdooServer(odoo_server: string) {\n    this.odoo_server = odoo_server;\n  }\n\n  public setHttpAuth(http_auth: string) {\n    this.http_auth = http_auth;\n  }\n\n  public sendRequest(url: string, params: Object): Promise<any> {\n    const body = this.buildRequest(url, params);\n    return this.http.post(this.odoo_server + url, body, {headers: this.headers})\n      .toPromise()\n      .then(this.handleOdooErrors)\n      .catch(this.handleHttpErrors);\n  }\n\n  public getServerInfo() {\n    return this.sendRequest('/web/webclient/version_info', {});\n  }\n\n  public getSessionInfo() {\n    return this.sendRequest('/web/session/get_session_info', {});\n  }\n\n  public login(db: string, login: string, password: string) {\n    const params = {\n      db: db,\n      login: login,\n      password: password\n    };\n    const $this = this;\n    return this.sendRequest('/web/session/authenticate', params).then(function (result: any) {\n      if (!result.uid) {\n        $this.cookies.delete_sessionId();\n        return Promise.reject({\n          title: 'wrong_login',\n          message: 'Username and password don\\'t match',\n          fullTrace: result\n        });\n      }\n      $this.context = result.user_context;\n      localStorage.setItem('user_context', JSON.stringify($this.context));\n      $this.cookies.set_sessionId(result.session_id);\n      return result;\n    });\n  }\n\n  public isLoggedIn(force: boolean = true) {\n    if (!force) {\n      return Promise.resolve(this.cookies.get_sessionId().length > 0);\n    }\n    return this.getSessionInfo().then((result: any) => {\n      this.cookies.set_sessionId(result.session_id);\n      return !!(result.uid);\n    });\n  }\n\n  public logout(force: boolean = true) {\n    this.cookies.delete_sessionId();\n    if (force) {\n      return this.getSessionInfo().then((r: any) => { // get db from sessionInfo\n        if (r.db) {\n          return this.login(r.db, '', '');\n        }\n      });\n    } else {\n      return Promise.resolve();\n    }\n  }\n\n  public getDbList() { // only use for odoo < 9.0\n    return this.sendRequest('/web/database/get_list', {});\n  }\n\n  public searchRead(model: string, domain: any, fields: any, limit: number, offset: number, context: any = {}, sort?: string) {\n    const params = {\n      model: model,\n      domain: domain,\n      fields: fields,\n      limit: limit,\n      offset: offset,\n      context: context || this.context,\n      sort: sort || ''\n    };\n    return this.sendRequest('/web/dataset/search_read', params);\n  }\n\n  public updateContext(context: any) {\n    localStorage.setItem('user_context', JSON.stringify(context));\n    const args = [[(<any>this.context).uid], context];\n    this.call('res.users', 'write', args, {})\n      .then(() => this.context = context)\n      .catch((err: any) => this.context = context);\n  }\n\n  public getContext() {\n    return this.context;\n  }\n\n  public getServer() {\n    return this.odoo_server;\n  }\n\n  public call(model: string, method: string, args: any, kwargs: any) {\n\n    kwargs = kwargs || {};\n    kwargs.context = kwargs.context || {};\n    (<any>Object).assign(kwargs.context, this.context);\n\n    const params = {\n      model: model,\n      method: method,\n      args: args,\n      kwargs: kwargs,\n    };\n    return this.sendRequest('/web/dataset/call_kw', params);\n  }\n\n  private buildRequest(url: string, params: any) {\n    this.uniq_id_counter += 1;\n    if (this.shouldManageSessionId) {\n      params.session_id = this.cookies.get_sessionId();\n    }\n\n    this.headers = new HttpHeaders({\n      'Content-Type': 'application/json',\n      'X-Openerp-Session-Id': this.cookies.get_sessionId(),\n      'Authorization': 'Basic ' + btoa(`${this.http_auth}`)\n    });\n    return JSON.stringify({\n      jsonrpc: '2.0',\n      method: 'call',\n      params: params, // payload\n    });\n  }\n\n  private handleOdooErrors(response: any) {\n    if (!response.error) {\n      return response.result;\n    }\n\n    const error = response.error;\n    const errorObj = {\n      title: '    ',\n      message: '',\n      fullTrace: error\n    };\n\n    if (error.code === 200 && error.message === 'Odoo Server Error' && error.data.name === 'werkzeug.exceptions.NotFound') {\n      errorObj.title = 'page_not_found';\n      errorObj.message = 'HTTP Error';\n    } else if ((error.code === 100 && error.message === 'Odoo Session Expired') || // v8\n      (error.code === 300 && error.message === 'OpenERP WebClient Error' && error.data.debug.match('SessionExpiredException')) // v7\n    ) {\n      errorObj.title = 'session_expired';\n      this.cookies.delete_sessionId();\n    } else if ((error.message === 'Odoo Server Error' && /FATAL:  database \"(.+)\" does not exist/.test(error.data.message))) {\n      errorObj.title = 'database_not_found';\n      errorObj.message = error.data.message;\n    } else if ((error.data.name === 'openerp.exceptions.AccessError')) {\n      errorObj.title = 'AccessError';\n      errorObj.message = error.data.message;\n    } else {\n      const split = ('' + error.data.fault_code).split('\\n')[0].split(' -- ');\n      if (split.length > 1) {\n        error.type = split.shift();\n        error.data.fault_code = error.data.fault_code.substr(error.type.length + 4);\n      }\n\n      if (error.code === 200 && error.type) {\n        errorObj.title = error.type;\n        errorObj.message = error.data.fault_code.replace(/\\n/g, '<br />');\n      } else {\n        errorObj.title = error.message;\n        errorObj.message = error.data.debug.replace(/\\n/g, '<br />');\n      }\n    }\n    return Promise.reject(errorObj);\n  }\n\n  private handleHttpErrors(error: any) {\n    return Promise.reject(error.message || error);\n  }\n\n}\n","import { NgModule } from '@angular/core';\n\n@NgModule({\n  imports: [\n  ],\n})\nexport class Angular6OdooJsonrpcModule { }\n"],"names":[],"mappings":"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"}
