/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { Inject, Injectable } from '@angular/core';
import { HttpClient, HttpHeaders } from '@angular/common/http';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
var Cookies = /** @class */ (function () {
    function Cookies() {
        this.session_id = null;
    }
    /**
     * @return {?}
     */
    Cookies.prototype.delete_sessionId = /**
     * @return {?}
     */
    function () {
        this.session_id = null;
        document.cookie = 'session_id=; expires=Wed, 29 Jun 2016 00:00:00 UTC';
    };
    /**
     * @return {?}
     */
    Cookies.prototype.get_sessionId = /**
     * @return {?}
     */
    function () {
        return document
            .cookie.split('; ')
            .filter(function (x) { return x.indexOf('session_id') === 0; })
            .map(function (x) { return x.split('=')[1]; })
            .pop() || this.session_id || '';
    };
    /**
     * @param {?} val
     * @return {?}
     */
    Cookies.prototype.set_sessionId = /**
     * @param {?} val
     * @return {?}
     */
    function (val) {
        document.cookie = "session_id=" + val;
        this.session_id = val;
    };
    return Cookies;
}());
function Cookies_tsickle_Closure_declarations() {
    /** @type {?} */
    Cookies.prototype.session_id;
}
var Ng6OdooRPCService = /** @class */ (function () {
    function Ng6OdooRPCService(http) {
        this.http = http;
        this.uniq_id_counter = 0;
        this.shouldManageSessionId = false;
        this.context = JSON.parse(localStorage.getItem('user_context')) || { 'lang': 'en_US' };
        this.cookies = new Cookies();
    }
    /**
     * @param {?} configs
     * @return {?}
     */
    Ng6OdooRPCService.prototype.init = /**
     * @param {?} configs
     * @return {?}
     */
    function (configs) {
        this.odoo_server = configs.odoo_server;
        this.http_auth = configs.http_auth || null;
    };
    /**
     * @param {?} odoo_server
     * @return {?}
     */
    Ng6OdooRPCService.prototype.setOdooServer = /**
     * @param {?} odoo_server
     * @return {?}
     */
    function (odoo_server) {
        this.odoo_server = odoo_server;
    };
    /**
     * @param {?} http_auth
     * @return {?}
     */
    Ng6OdooRPCService.prototype.setHttpAuth = /**
     * @param {?} http_auth
     * @return {?}
     */
    function (http_auth) {
        this.http_auth = http_auth;
    };
    /**
     * @param {?} url
     * @param {?} params
     * @return {?}
     */
    Ng6OdooRPCService.prototype.sendRequest = /**
     * @param {?} url
     * @param {?} params
     * @return {?}
     */
    function (url, params) {
        var /** @type {?} */ body = this.buildRequest(url, params);
        return this.http.post(this.odoo_server + url, body, { headers: this.headers })
            .toPromise()
            .then(this.handleOdooErrors)
            .catch(this.handleHttpErrors);
    };
    /**
     * @return {?}
     */
    Ng6OdooRPCService.prototype.getServerInfo = /**
     * @return {?}
     */
    function () {
        return this.sendRequest('/web/webclient/version_info', {});
    };
    /**
     * @return {?}
     */
    Ng6OdooRPCService.prototype.getSessionInfo = /**
     * @return {?}
     */
    function () {
        return this.sendRequest('/web/session/get_session_info', {});
    };
    /**
     * @param {?} db
     * @param {?} login
     * @param {?} password
     * @return {?}
     */
    Ng6OdooRPCService.prototype.login = /**
     * @param {?} db
     * @param {?} login
     * @param {?} password
     * @return {?}
     */
    function (db, login, password) {
        var /** @type {?} */ params = {
            db: db,
            login: login,
            password: password
        };
        var /** @type {?} */ $this = this;
        return this.sendRequest('/web/session/authenticate', params).then(function (result) {
            if (!result.uid) {
                $this.cookies.delete_sessionId();
                return Promise.reject({
                    title: 'wrong_login',
                    message: 'Username and password don\'t match',
                    fullTrace: result
                });
            }
            $this.context = result.user_context;
            localStorage.setItem('user_context', JSON.stringify($this.context));
            $this.cookies.set_sessionId(result.session_id);
            return result;
        });
    };
    /**
     * @param {?=} force
     * @return {?}
     */
    Ng6OdooRPCService.prototype.isLoggedIn = /**
     * @param {?=} force
     * @return {?}
     */
    function (force) {
        var _this = this;
        if (force === void 0) { force = true; }
        if (!force) {
            return Promise.resolve(this.cookies.get_sessionId().length > 0);
        }
        return this.getSessionInfo().then(function (result) {
            _this.cookies.set_sessionId(result.session_id);
            return !!(result.uid);
        });
    };
    /**
     * @param {?=} force
     * @return {?}
     */
    Ng6OdooRPCService.prototype.logout = /**
     * @param {?=} force
     * @return {?}
     */
    function (force) {
        var _this = this;
        if (force === void 0) { force = true; }
        this.cookies.delete_sessionId();
        if (force) {
            return this.getSessionInfo().then(function (r) {
                // get db from sessionInfo
                if (r.db) {
                    return _this.login(r.db, '', '');
                }
            });
        }
        else {
            return Promise.resolve();
        }
    };
    /**
     * @return {?}
     */
    Ng6OdooRPCService.prototype.getDbList = /**
     * @return {?}
     */
    function () {
        // only use for odoo < 9.0
        return this.sendRequest('/web/database/get_list', {});
    };
    /**
     * @param {?} model
     * @param {?} domain
     * @param {?} fields
     * @param {?} limit
     * @param {?} offset
     * @param {?=} context
     * @param {?=} sort
     * @return {?}
     */
    Ng6OdooRPCService.prototype.searchRead = /**
     * @param {?} model
     * @param {?} domain
     * @param {?} fields
     * @param {?} limit
     * @param {?} offset
     * @param {?=} context
     * @param {?=} sort
     * @return {?}
     */
    function (model, domain, fields, limit, offset, context, sort) {
        if (context === void 0) { context = {}; }
        var /** @type {?} */ params = {
            model: model,
            domain: domain,
            fields: fields,
            limit: limit,
            offset: offset,
            context: context || this.context,
            sort: sort || ''
        };
        return this.sendRequest('/web/dataset/search_read', params);
    };
    /**
     * @param {?} context
     * @return {?}
     */
    Ng6OdooRPCService.prototype.updateContext = /**
     * @param {?} context
     * @return {?}
     */
    function (context) {
        var _this = this;
        localStorage.setItem('user_context', JSON.stringify(context));
        var /** @type {?} */ args = [[(/** @type {?} */ (this.context)).uid], context];
        this.call('res.users', 'write', args, {})
            .then(function () { return _this.context = context; })
            .catch(function (err) { return _this.context = context; });
    };
    /**
     * @return {?}
     */
    Ng6OdooRPCService.prototype.getContext = /**
     * @return {?}
     */
    function () {
        return this.context;
    };
    /**
     * @return {?}
     */
    Ng6OdooRPCService.prototype.getServer = /**
     * @return {?}
     */
    function () {
        return this.odoo_server;
    };
    /**
     * @param {?} model
     * @param {?} method
     * @param {?} args
     * @param {?} kwargs
     * @return {?}
     */
    Ng6OdooRPCService.prototype.call = /**
     * @param {?} model
     * @param {?} method
     * @param {?} args
     * @param {?} kwargs
     * @return {?}
     */
    function (model, method, args, kwargs) {
        kwargs = kwargs || {};
        kwargs.context = kwargs.context || {};
        (/** @type {?} */ (Object)).assign(kwargs.context, this.context);
        var /** @type {?} */ params = {
            model: model,
            method: method,
            args: args,
            kwargs: kwargs,
        };
        return this.sendRequest('/web/dataset/call_kw', params);
    };
    /**
     * @param {?} url
     * @param {?} params
     * @return {?}
     */
    Ng6OdooRPCService.prototype.buildRequest = /**
     * @param {?} url
     * @param {?} params
     * @return {?}
     */
    function (url, params) {
        this.uniq_id_counter += 1;
        if (this.shouldManageSessionId) {
            params.session_id = this.cookies.get_sessionId();
        }
        this.headers = new HttpHeaders({
            'Content-Type': 'application/json',
            'X-Openerp-Session-Id': this.cookies.get_sessionId(),
            'Authorization': 'Basic ' + btoa("" + this.http_auth)
        });
        return JSON.stringify({
            jsonrpc: '2.0',
            method: 'call',
            params: params,
        });
    };
    /**
     * @param {?} response
     * @return {?}
     */
    Ng6OdooRPCService.prototype.handleOdooErrors = /**
     * @param {?} response
     * @return {?}
     */
    function (response) {
        if (!response.error) {
            return response.result;
        }
        var /** @type {?} */ error = response.error;
        var /** @type {?} */ errorObj = {
            title: '    ',
            message: '',
            fullTrace: error
        };
        if (error.code === 200 && error.message === 'Odoo Server Error' && error.data.name === 'werkzeug.exceptions.NotFound') {
            errorObj.title = 'page_not_found';
            errorObj.message = 'HTTP Error';
        }
        else if ((error.code === 100 && error.message === 'Odoo Session Expired') || // v8
            // v8
            (error.code === 300 && error.message === 'OpenERP WebClient Error' && error.data.debug.match('SessionExpiredException')) // v7
        ) {
            errorObj.title = 'session_expired';
            this.cookies.delete_sessionId();
        }
        else if ((error.message === 'Odoo Server Error' && /FATAL:  database "(.+)" does not exist/.test(error.data.message))) {
            errorObj.title = 'database_not_found';
            errorObj.message = error.data.message;
        }
        else if ((error.data.name === 'openerp.exceptions.AccessError')) {
            errorObj.title = 'AccessError';
            errorObj.message = error.data.message;
        }
        else {
            var /** @type {?} */ split = ('' + error.data.fault_code).split('\n')[0].split(' -- ');
            if (split.length > 1) {
                error.type = split.shift();
                error.data.fault_code = error.data.fault_code.substr(error.type.length + 4);
            }
            if (error.code === 200 && error.type) {
                errorObj.title = error.type;
                errorObj.message = error.data.fault_code.replace(/\n/g, '<br />');
            }
            else {
                errorObj.title = error.message;
                errorObj.message = error.data.debug.replace(/\n/g, '<br />');
            }
        }
        return Promise.reject(errorObj);
    };
    /**
     * @param {?} error
     * @return {?}
     */
    Ng6OdooRPCService.prototype.handleHttpErrors = /**
     * @param {?} error
     * @return {?}
     */
    function (error) {
        return Promise.reject(error.message || error);
    };
    Ng6OdooRPCService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] },
    ];
    /** @nocollapse */
    Ng6OdooRPCService.ctorParameters = function () { return [
        { type: HttpClient, decorators: [{ type: Inject, args: [HttpClient,] }] }
    ]; };
    /** @nocollapse */ Ng6OdooRPCService.ngInjectableDef = i0.defineInjectable({ factory: function Ng6OdooRPCService_Factory() { return new Ng6OdooRPCService(i0.inject(i1.HttpClient)); }, token: Ng6OdooRPCService, providedIn: "root" });
    return Ng6OdooRPCService;
}());
export { Ng6OdooRPCService };
function Ng6OdooRPCService_tsickle_Closure_declarations() {
    /** @type {?} */
    Ng6OdooRPCService.prototype.cookies;
    /** @type {?} */
    Ng6OdooRPCService.prototype.uniq_id_counter;
    /** @type {?} */
    Ng6OdooRPCService.prototype.shouldManageSessionId;
    /** @type {?} */
    Ng6OdooRPCService.prototype.context;
    /** @type {?} */
    Ng6OdooRPCService.prototype.headers;
    /** @type {?} */
    Ng6OdooRPCService.prototype.http_auth;
    /** @type {?} */
    Ng6OdooRPCService.prototype.odoo_server;
    /** @type {?} */
    Ng6OdooRPCService.prototype.http;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5ndWxhcjYtb2Rvby1qc29ucnBjLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9hbmd1bGFyNi1vZG9vLWpzb25ycGMvIiwic291cmNlcyI6WyJsaWIvYW5ndWxhcjYtb2Rvby1qc29ucnBjLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBQyxNQUFNLEVBQUUsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ2pELE9BQU8sRUFBQyxVQUFVLEVBQUUsV0FBVyxFQUFDLE1BQU0sc0JBQXNCLENBQUM7OztBQUU3RCxJQUFBOzswQkFDK0IsSUFBSTs7Ozs7SUFFakMsa0NBQWdCOzs7SUFBaEI7UUFDRSxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztRQUN2QixRQUFRLENBQUMsTUFBTSxHQUFHLG9EQUFvRCxDQUFDO0tBQ3hFOzs7O0lBRUQsK0JBQWE7OztJQUFiO1FBQ0UsTUFBTSxDQUFDLFFBQVE7YUFDWixNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQzthQUNsQixNQUFNLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsRUFBN0IsQ0FBNkIsQ0FBQzthQUMxQyxHQUFHLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFmLENBQWUsQ0FBQzthQUN6QixHQUFHLEVBQUUsSUFBSSxJQUFJLENBQUMsVUFBVSxJQUFJLEVBQUUsQ0FBQztLQUNuQzs7Ozs7SUFFRCwrQkFBYTs7OztJQUFiLFVBQWMsR0FBVztRQUN2QixRQUFRLENBQUMsTUFBTSxHQUFHLGdCQUFjLEdBQUssQ0FBQztRQUN0QyxJQUFJLENBQUMsVUFBVSxHQUFHLEdBQUcsQ0FBQztLQUN2QjtrQkF0Qkg7SUF1QkMsQ0FBQTs7Ozs7O0lBZUMsMkJBQzhCLElBQWdCO1FBQWhCLFNBQUks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SyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUM7Z0JBQy9CLFFBQVEsQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQzthQUM5RDtTQUNGO1FBQ0QsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7Ozs7OztJQUcxQiw0Q0FBZ0I7Ozs7Y0FBQyxLQUFVO1FBQ2pDLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLElBQUksS0FBSyxDQUFDLENBQUM7OztnQkEzTWpELFVBQVUsU0FBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkI7Ozs7Z0JBM0JPLFVBQVUsdUJBc0NiLE1BQU0sU0FBQyxVQUFVOzs7NEJBdkN0Qjs7U0E2QmEsaUJBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJbmplY3QsIEluamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtIdHRwQ2xpZW50LCBIdHRwSGVhZGVyc30gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuXG5jbGFzcyBDb29raWVzIHsgLy8gY29va2llcyBkb2Vzbid0IHdvcmsgd2l0aCBBbmRyb2lkIGRlZmF1bHQgYnJvd3NlciAvIElvbmljXG4gIHByaXZhdGUgc2Vzc2lvbl9pZDogc3RyaW5nID0gbnVsbDtcblxuICBkZWxldGVfc2Vzc2lvbklkKCkge1xuICAgIHRoaXMuc2Vzc2lvbl9pZCA9IG51bGw7XG4gICAgZG9jdW1lbnQuY29va2llID0gJ3Nlc3Npb25faWQ9OyBleHBpcmVzPVdlZCwgMjkgSnVuIDIwMTYgMDA6MDA6MDAgVVRDJztcbiAgfVxuXG4gIGdldF9zZXNzaW9uSWQoKSB7XG4gICAgcmV0dXJuIGRvY3VtZW50XG4gICAgICAuY29va2llLnNwbGl0KCc7ICcpXG4gICAgICAuZmlsdGVyKHggPT4geC5pbmRleE9mKCdzZXNzaW9uX2lkJykgPT09IDApXG4gICAgICAubWFwKHggPT4geC5zcGxpdCgnPScpWzFdKVxuICAgICAgLnBvcCgpIHx8IHRoaXMuc2Vzc2lvbl9pZCB8fCAnJztcbiAgfVxuXG4gIHNldF9zZXNzaW9uSWQodmFsOiBzdHJpbmcpIHtcbiAgICBkb2N1bWVudC5jb29raWUgPSBgc2Vzc2lvbl9pZD0ke3ZhbH1gO1xuICAgIHRoaXMuc2Vzc2lvbl9pZCA9IHZhbDtcbiAgfVxufVxuXG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIE5nNk9kb29SUENTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBjb29raWVzOiBDb29raWVzO1xuICBwcml2YXRlIHVuaXFfaWRfY291bnRlciA9IDA7XG4gIHByaXZhdGUgc2hvdWxkTWFuYWdlU2Vzc2lvbklkID0gZmFsc2U7IC8vIHRyeSB3aXRob3V0IGZpcnN0XG4gIHByaXZhdGUgY29udGV4dDogT2JqZWN0ID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgndXNlcl9jb250ZXh0JykpIHx8IHsnbGFuZyc6ICdlbl9VUyd9O1xuICBwcml2YXRlIGhlYWRlcnM6IEh0dHBIZWFkZXJzO1xuICBwcml2YXRlIGh0dHBfYXV0aDogc3RyaW5nO1xuICBwcml2YXRlIG9kb29fc2VydmVyOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdChIdHRwQ2xpZW50KSBwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQpIHtcbiAgICB0aGlzLmNvb2tpZXMgPSBuZXcgQ29va2llcygpO1xuICB9XG5cbiAgcHVibGljIGluaXQoY29uZmlnczogYW55KSB7XG4gICAgdGhpcy5vZG9vX3NlcnZlciA9IGNvbmZpZ3Mub2Rvb19zZXJ2ZXI7XG4gICAgdGhpcy5odHRwX2F1dGggPSBjb25maWdzLmh0dHBfYXV0aCB8fCBudWxsO1xuICB9XG5cbiAgcHVibGljIHNldE9kb29TZXJ2ZXIob2Rvb19zZXJ2ZXI6IHN0cmluZykge1xuICAgIHRoaXMub2Rvb19zZXJ2ZXIgPSBvZG9vX3NlcnZlcjtcbiAgfVxuXG4gIHB1YmxpYyBzZXRIdHRwQXV0aChodHRwX2F1dGg6IHN0cmluZykge1xuICAgIHRoaXMuaHR0cF9hdXRoID0gaHR0cF9hdXRoO1xuICB9XG5cbiAgcHVibGljIHNlbmRSZXF1ZXN0KHVybDogc3RyaW5nLCBwYXJhbXM6IE9iamVjdCk6IFByb21pc2U8YW55PiB7XG4gICAgY29uc3QgYm9keSA9IHRoaXMuYnVpbGRSZXF1ZXN0KHVybCwgcGFyYW1zKTtcbiAgICByZXR1cm4gdGhpcy5odHRwLnBvc3QodGhpcy5vZG9vX3NlcnZlciArIHVybCwgYm9keSwge2hlYWRlcnM6IHRoaXMuaGVhZGVyc30pXG4gICAgICAudG9Qcm9taXNlKClcbiAgICAgIC50aGVuKHRoaXMuaGFuZGxlT2Rvb0Vycm9ycylcbiAgICAgIC5jYXRjaCh0aGlzLmhhbmRsZUh0dHBFcnJvcnMpO1xuICB9XG5cbiAgcHVibGljIGdldFNlcnZlckluZm8oKSB7XG4gICAgcmV0dXJuIHRoaXMuc2VuZFJlcXVlc3QoJy93ZWIvd2ViY2xpZW50L3ZlcnNpb25faW5mbycsIHt9KTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRTZXNzaW9uSW5mbygpIHtcbiAgICByZXR1cm4gdGhpcy5zZW5kUmVxdWVzdCgnL3dlYi9zZXNzaW9uL2dldF9zZXNzaW9uX2luZm8nLCB7fSk7XG4gIH1cblxuICBwdWJsaWMgbG9naW4oZGI6IHN0cmluZywgbG9naW46IHN0cmluZywgcGFzc3dvcmQ6IHN0cmluZykge1xuICAgIGNvbnN0IHBhcmFtcyA9IHtcbiAgICAgIGRiOiBkYixcbiAgICAgIGxvZ2luOiBsb2dpbixcbiAgICAgIHBhc3N3b3JkOiBwYXNzd29yZFxuICAgIH07XG4gICAgY29uc3QgJHRoaXMgPSB0aGlzO1xuICAgIHJldHVybiB0aGlzLnNlbmRSZXF1ZXN0KCcvd2ViL3Nlc3Npb24vYXV0aGVudGljYXRlJywgcGFyYW1zKS50aGVuKGZ1bmN0aW9uIChyZXN1bHQ6IGFueSkge1xuICAgICAgaWYgKCFyZXN1bHQudWlkKSB7XG4gICAgICAgICR0aGlzLmNvb2tpZXMuZGVsZXRlX3Nlc3Npb25JZCgpO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3Qoe1xuICAgICAgICAgIHRpdGxlOiAnd3JvbmdfbG9naW4nLFxuICAgICAgICAgIG1lc3NhZ2U6ICdVc2VybmFtZSBhbmQgcGFzc3dvcmQgZG9uXFwndCBtYXRjaCcsXG4gICAgICAgICAgZnVsbFRyYWNlOiByZXN1bHRcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICAkdGhpcy5jb250ZXh0ID0gcmVzdWx0LnVzZXJfY29udGV4dDtcbiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCd1c2VyX2NvbnRleHQnLCBKU09OLnN0cmluZ2lmeSgkdGhpcy5jb250ZXh0KSk7XG4gICAgICAkdGhpcy5jb29raWVzLnNldF9zZXNzaW9uSWQocmVzdWx0LnNlc3Npb25faWQpO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBpc0xvZ2dlZEluKGZvcmNlOiBib29sZWFuID0gdHJ1ZSkge1xuICAgIGlmICghZm9yY2UpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodGhpcy5jb29raWVzLmdldF9zZXNzaW9uSWQoKS5sZW5ndGggPiAwKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuZ2V0U2Vzc2lvbkluZm8oKS50aGVuKChyZXN1bHQ6IGFueSkgPT4ge1xuICAgICAgdGhpcy5jb29raWVzLnNldF9zZXNzaW9uSWQocmVzdWx0LnNlc3Npb25faWQpO1xuICAgICAgcmV0dXJuICEhKHJlc3VsdC51aWQpO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGxvZ291dChmb3JjZTogYm9vbGVhbiA9IHRydWUpIHtcbiAgICB0aGlzLmNvb2tpZXMuZGVsZXRlX3Nlc3Npb25JZCgpO1xuICAgIGlmIChmb3JjZSkge1xuICAgICAgcmV0dXJuIHRoaXMuZ2V0U2Vzc2lvbkluZm8oKS50aGVuKChyOiBhbnkpID0+IHsgLy8gZ2V0IGRiIGZyb20gc2Vzc2lvbkluZm9cbiAgICAgICAgaWYgKHIuZGIpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5sb2dpbihyLmRiLCAnJywgJycpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXREYkxpc3QoKSB7IC8vIG9ubHkgdXNlIGZvciBvZG9vIDwgOS4wXG4gICAgcmV0dXJuIHRoaXMuc2VuZFJlcXVlc3QoJy93ZWIvZGF0YWJhc2UvZ2V0X2xpc3QnLCB7fSk7XG4gIH1cblxuICBwdWJsaWMgc2VhcmNoUmVhZChtb2RlbDogc3RyaW5nLCBkb21haW46IGFueSwgZmllbGRzOiBhbnksIGxpbWl0OiBudW1iZXIsIG9mZnNldDogbnVtYmVyLCBjb250ZXh0OiBhbnkgPSB7fSwgc29ydD86IHN0cmluZykge1xuICAgIGNvbnN0IHBhcmFtcyA9IHtcbiAgICAgIG1vZGVsOiBtb2RlbCxcbiAgICAgIGRvbWFpbjogZG9tYWluLFxuICAgICAgZmllbGRzOiBmaWVsZHMsXG4gICAgICBsaW1pdDogbGltaXQsXG4gICAgICBvZmZzZXQ6IG9mZnNldCxcbiAgICAgIGNvbnRleHQ6IGNvbnRleHQgfHwgdGhpcy5jb250ZXh0LFxuICAgICAgc29ydDogc29ydCB8fCAnJ1xuICAgIH07XG4gICAgcmV0dXJuIHRoaXMuc2VuZFJlcXVlc3QoJy93ZWIvZGF0YXNldC9zZWFyY2hfcmVhZCcsIHBhcmFtcyk7XG4gIH1cblxuICBwdWJsaWMgdXBkYXRlQ29udGV4dChjb250ZXh0OiBhbnkpIHtcbiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgndXNlcl9jb250ZXh0JywgSlNPTi5zdHJpbmdpZnkoY29udGV4dCkpO1xuICAgIGNvbnN0IGFyZ3MgPSBbWyg8YW55PnRoaXMuY29udGV4dCkudWlkXSwgY29udGV4dF07XG4gICAgdGhpcy5jYWxsKCdyZXMudXNlcnMnLCAnd3JpdGUnLCBhcmdzLCB7fSlcbiAgICAgIC50aGVuKCgpID0+IHRoaXMuY29udGV4dCA9IGNvbnRleHQpXG4gICAgICAuY2F0Y2goKGVycjogYW55KSA9PiB0aGlzLmNvbnRleHQgPSBjb250ZXh0KTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRDb250ZXh0KCkge1xuICAgIHJldHVybiB0aGlzLmNvbnRleHQ7XG4gIH1cblxuICBwdWJsaWMgZ2V0U2VydmVyKCkge1xuICAgIHJldHVybiB0aGlzLm9kb29fc2VydmVyO1xuICB9XG5cbiAgcHVibGljIGNhbGwobW9kZWw6IHN0cmluZywgbWV0aG9kOiBzdHJpbmcsIGFyZ3M6IGFueSwga3dhcmdzOiBhbnkpIHtcblxuICAgIGt3YXJncyA9IGt3YXJncyB8fCB7fTtcbiAgICBrd2FyZ3MuY29udGV4dCA9IGt3YXJncy5jb250ZXh0IHx8IHt9O1xuICAgICg8YW55Pk9iamVjdCkuYXNzaWduKGt3YXJncy5jb250ZXh0LCB0aGlzLmNvbnRleHQpO1xuXG4gICAgY29uc3QgcGFyYW1zID0ge1xuICAgICAgbW9kZWw6IG1vZGVsLFxuICAgICAgbWV0aG9kOiBtZXRob2QsXG4gICAgICBhcmdzOiBhcmdzLFxuICAgICAga3dhcmdzOiBrd2FyZ3MsXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5zZW5kUmVxdWVzdCgnL3dlYi9kYXRhc2V0L2NhbGxfa3cnLCBwYXJhbXMpO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZFJlcXVlc3QodXJsOiBzdHJpbmcsIHBhcmFtczogYW55KSB7XG4gICAgdGhpcy51bmlxX2lkX2NvdW50ZXIgKz0gMTtcbiAgICBpZiAodGhpcy5zaG91bGRNYW5hZ2VTZXNzaW9uSWQpIHtcbiAgICAgIHBhcmFtcy5zZXNzaW9uX2lkID0gdGhpcy5jb29raWVzLmdldF9zZXNzaW9uSWQoKTtcbiAgICB9XG5cbiAgICB0aGlzLmhlYWRlcnMgPSBuZXcgSHR0cEhlYWRlcnMoe1xuICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICdYLU9wZW5lcnAtU2Vzc2lvbi1JZCc6IHRoaXMuY29va2llcy5nZXRfc2Vzc2lvbklkKCksXG4gICAgICAnQXV0aG9yaXphdGlvbic6ICdCYXNpYyAnICsgYnRvYShgJHt0aGlzLmh0dHBfYXV0aH1gKVxuICAgIH0pO1xuICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICBqc29ucnBjOiAnMi4wJyxcbiAgICAgIG1ldGhvZDogJ2NhbGwnLFxuICAgICAgcGFyYW1zOiBwYXJhbXMsIC8vIHBheWxvYWRcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlT2Rvb0Vycm9ycyhyZXNwb25zZTogYW55KSB7XG4gICAgaWYgKCFyZXNwb25zZS5lcnJvcikge1xuICAgICAgcmV0dXJuIHJlc3BvbnNlLnJlc3VsdDtcbiAgICB9XG5cbiAgICBjb25zdCBlcnJvciA9IHJlc3BvbnNlLmVycm9yO1xuICAgIGNvbnN0IGVycm9yT2JqID0ge1xuICAgICAgdGl0bGU6ICcgICAgJyxcbiAgICAgIG1lc3NhZ2U6ICcnLFxuICAgICAgZnVsbFRyYWNlOiBlcnJvclxuICAgIH07XG5cbiAgICBpZiAoZXJyb3IuY29kZSA9PT0gMjAwICYmIGVycm9yLm1lc3NhZ2UgPT09ICdPZG9vIFNlcnZlciBFcnJvcicgJiYgZXJyb3IuZGF0YS5uYW1lID09PSAnd2Vya3pldWcuZXhjZXB0aW9ucy5Ob3RGb3VuZCcpIHtcbiAgICAgIGVycm9yT2JqLnRpdGxlID0gJ3BhZ2Vfbm90X2ZvdW5kJztcbiAgICAgIGVycm9yT2JqLm1lc3NhZ2UgPSAnSFRUUCBFcnJvcic7XG4gICAgfSBlbHNlIGlmICgoZXJyb3IuY29kZSA9PT0gMTAwICYmIGVycm9yLm1lc3NhZ2UgPT09ICdPZG9vIFNlc3Npb24gRXhwaXJlZCcpIHx8IC8vIHY4XG4gICAgICAoZXJyb3IuY29kZSA9PT0gMzAwICYmIGVycm9yLm1lc3NhZ2UgPT09ICdPcGVuRVJQIFdlYkNsaWVudCBFcnJvcicgJiYgZXJyb3IuZGF0YS5kZWJ1Zy5tYXRjaCgnU2Vzc2lvbkV4cGlyZWRFeGNlcHRpb24nKSkgLy8gdjdcbiAgICApIHtcbiAgICAgIGVycm9yT2JqLnRpdGxlID0gJ3Nlc3Npb25fZXhwaXJlZCc7XG4gICAgICB0aGlzLmNvb2tpZXMuZGVsZXRlX3Nlc3Npb25JZCgpO1xuICAgIH0gZWxzZSBpZiAoKGVycm9yLm1lc3NhZ2UgPT09ICdPZG9vIFNlcnZlciBFcnJvcicgJiYgL0ZBVEFMOiAgZGF0YWJhc2UgXCIoLispXCIgZG9lcyBub3QgZXhpc3QvLnRlc3QoZXJyb3IuZGF0YS5tZXNzYWdlKSkpIHtcbiAgICAgIGVycm9yT2JqLnRpdGxlID0gJ2RhdGFiYXNlX25vdF9mb3VuZCc7XG4gICAgICBlcnJvck9iai5tZXNzYWdlID0gZXJyb3IuZGF0YS5tZXNzYWdlO1xuICAgIH0gZWxzZSBpZiAoKGVycm9yLmRhdGEubmFtZSA9PT0gJ29wZW5lcnAuZXhjZXB0aW9ucy5BY2Nlc3NFcnJvcicpKSB7XG4gICAgICBlcnJvck9iai50aXRsZSA9ICdBY2Nlc3NFcnJvcic7XG4gICAgICBlcnJvck9iai5tZXNzYWdlID0gZXJyb3IuZGF0YS5tZXNzYWdlO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBzcGxpdCA9ICgnJyArIGVycm9yLmRhdGEuZmF1bHRfY29kZSkuc3BsaXQoJ1xcbicpWzBdLnNwbGl0KCcgLS0gJyk7XG4gICAgICBpZiAoc3BsaXQubGVuZ3RoID4gMSkge1xuICAgICAgICBlcnJvci50eXBlID0gc3BsaXQuc2hpZnQoKTtcbiAgICAgICAgZXJyb3IuZGF0YS5mYXVsdF9jb2RlID0gZXJyb3IuZGF0YS5mYXVsdF9jb2RlLnN1YnN0cihlcnJvci50eXBlLmxlbmd0aCArIDQpO1xuICAgICAgfVxuXG4gICAgICBpZiAoZXJyb3IuY29kZSA9PT0gMjAwICYmIGVycm9yLnR5cGUpIHtcbiAgICAgICAgZXJyb3JPYmoudGl0bGUgPSBlcnJvci50eXBlO1xuICAgICAgICBlcnJvck9iai5tZXNzYWdlID0gZXJyb3IuZGF0YS5mYXVsdF9jb2RlLnJlcGxhY2UoL1xcbi9nLCAnPGJyIC8+Jyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBlcnJvck9iai50aXRsZSA9IGVycm9yLm1lc3NhZ2U7XG4gICAgICAgIGVycm9yT2JqLm1lc3NhZ2UgPSBlcnJvci5kYXRhLmRlYnVnLnJlcGxhY2UoL1xcbi9nLCAnPGJyIC8+Jyk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnJvck9iaik7XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZUh0dHBFcnJvcnMoZXJyb3I6IGFueSkge1xuICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnJvci5tZXNzYWdlIHx8IGVycm9yKTtcbiAgfVxuXG59XG4iXX0=