!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common/http")):"function"==typeof define&&define.amd?define("angular6-odoo-jsonrpc",["exports","@angular/core","@angular/common/http"],t):t(e["angular6-odoo-jsonrpc"]={},e.ng.core,e.ng.common.http)}(this,function(e,t,o){"use strict";var s=function(){function e(){this.session_id=null}return e.prototype.delete_sessionId=function(){this.session_id=null,document.cookie="session_id=; expires=Wed, 29 Jun 2016 00:00:00 UTC"},e.prototype.get_sessionId=function(){return document.cookie.split("; ").filter(function(e){return 0===e.indexOf("session_id")}).map(function(e){return e.split("=")[1]}).pop()||this.session_id||""},e.prototype.set_sessionId=function(e){document.cookie="session_id="+e,this.session_id=e},e}(),n=function(){function e(e){this.http=e,this.uniq_id_counter=0,this.shouldManageSessionId=!1,this.context=JSON.parse(localStorage.getItem("user_context"))||{lang:"en_US"},this.cookies=new s}return e.prototype.init=function(e){this.odoo_server=e.odoo_server,this.http_auth=e.http_auth||null},e.prototype.setOdooServer=function(e){this.odoo_server=e},e.prototype.setHttpAuth=function(e){this.http_auth=e},e.prototype.sendRequest=function(e,t){var o=this.buildRequest(e,t);return this.http.post(this.odoo_server+e,o,{headers:this.headers}).toPromise().then(this.handleOdooErrors)["catch"](this.handleHttpErrors)},e.prototype.getServerInfo=function(){return this.sendRequest("/web/webclient/version_info",{})},e.prototype.getSessionInfo=function(){return this.sendRequest("/web/session/get_session_info",{})},e.prototype.login=function(e,t,o){var s={db:e,login:t,password:o},n=this;return this.sendRequest("/web/session/authenticate",s).then(function(e){return e.uid?(n.context=e.user_context,localStorage.setItem("user_context",JSON.stringify(n.context)),n.cookies.set_sessionId(e.session_id),e):(n.cookies.delete_sessionId(),Promise.reject({title:"wrong_login",message:"Username and password don't match",fullTrace:e}))})},e.prototype.isLoggedIn=function(e){var t=this;return void 0===e&&(e=!0),e?this.getSessionInfo().then(function(e){return t.cookies.set_sessionId(e.session_id),!!e.uid}):Promise.resolve(0<this.cookies.get_sessionId().length)},e.prototype.logout=function(e){var t=this;return void 0===e&&(e=!0),this.cookies.delete_sessionId(),e?this.getSessionInfo().then(function(e){if(e.db)return t.login(e.db,"","")}):Promise.resolve()},e.prototype.getDbList=function(){return this.sendRequest("/web/database/get_list",{})},e.prototype.searchRead=function(e,t,o,s,n,r,i){void 0===r&&(r={});var a={model:e,domain:t,fields:o,limit:s,offset:n,context:r||this.context,sort:i||""};return this.sendRequest("/web/dataset/search_read",a)},e.prototype.updateContext=function(t){var o=this;localStorage.setItem("user_context",JSON.stringify(t));var e=[[this.context.uid],t];this.call("res.users","write",e,{}).then(function(){return o.context=t})["catch"](function(e){return o.context=t})},e.prototype.getContext=function(){return this.context},e.prototype.getServer=function(){return this.odoo_server},e.prototype.call=function(e,t,o,s){(s=s||{}).context=s.context||{},Object.assign(s.context,this.context);var n={model:e,method:t,args:o,kwargs:s};return this.sendRequest("/web/dataset/call_kw",n)},e.prototype.buildRequest=function(e,t){return this.uniq_id_counter+=1,this.shouldManageSessionId&&(t.session_id=this.cookies.get_sessionId()),this.headers=new o.HttpHeaders({"Content-Type":"application/json","X-Openerp-Session-Id":this.cookies.get_sessionId(),Authorization:"Basic "+btoa(""+this.http_auth)}),JSON.stringify({jsonrpc:"2.0",method:"call",params:t})},e.prototype.handleOdooErrors=function(e){if(!e.error)return e.result;var t=e.error,o={title:"    ",message:"",fullTrace:t};if(200===t.code&&"Odoo Server Error"===t.message&&"werkzeug.exceptions.NotFound"===t.data.name)o.title="page_not_found",o.message="HTTP Error";else if(100===t.code&&"Odoo Session Expired"===t.message||300===t.code&&"OpenERP WebClient Error"===t.message&&t.data.debug.match("SessionExpiredException"))o.title="session_expired",this.cookies.delete_sessionId();else if("Odoo Server Error"===t.message&&/FATAL:  database "(.+)" does not exist/.test(t.data.message))o.title="database_not_found",o.message=t.data.message;else if("openerp.exceptions.AccessError"===t.data.name)o.title="AccessError",o.message=t.data.message;else{var s=(""+t.data.fault_code).split("\n")[0].split(" -- ");1<s.length&&(t.type=s.shift(),t.data.fault_code=t.data.fault_code.substr(t.type.length+4)),200===t.code&&t.type?(o.title=t.type,o.message=t.data.fault_code.replace(/\n/g,"<br />")):(o.title=t.message,o.message=t.data.debug.replace(/\n/g,"<br />"))}return Promise.reject(o)},e.prototype.handleHttpErrors=function(e){return Promise.reject(e.message||e)},e.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:o.HttpClient,decorators:[{type:t.Inject,args:[o.HttpClient]}]}]},e.ngInjectableDef=t.defineInjectable({factory:function(){return new e(t.inject(o.HttpClient))},token:e,providedIn:"root"}),e}(),r=function(){function e(){}return e.decorators=[{type:t.NgModule,args:[{imports:[]}]}],e}();e.Ng6OdooRPCService=n,e.Angular6OdooJsonrpcModule=r,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=angular6-odoo-jsonrpc.umd.min.js.map