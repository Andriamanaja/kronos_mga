{"version":3,"file":"angular6-odoo-jsonrpc.umd.js.map","sources":["ng://angular6-odoo-jsonrpc/lib/angular6-odoo-jsonrpc.service.ts","ng://angular6-odoo-jsonrpc/lib/angular6-odoo-jsonrpc.module.ts"],"sourcesContent":["import {Inject, Injectable} from '@angular/core';\nimport {HttpClient, HttpHeaders} from '@angular/common/http';\n\nclass Cookies { // cookies doesn't work with Android default browser / Ionic\n  private session_id: string = null;\n\n  delete_sessionId() {\n    this.session_id = null;\n    document.cookie = 'session_id=; expires=Wed, 29 Jun 2016 00:00:00 UTC';\n  }\n\n  get_sessionId() {\n    return document\n      .cookie.split('; ')\n      .filter(x => x.indexOf('session_id') === 0)\n      .map(x => x.split('=')[1])\n      .pop() || this.session_id || '';\n  }\n\n  set_sessionId(val: string) {\n    document.cookie = `session_id=${val}`;\n    this.session_id = val;\n  }\n}\n\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class Ng6OdooRPCService {\n  private cookies: Cookies;\n  private uniq_id_counter = 0;\n  private shouldManageSessionId = false; // try without first\n  private context: Object = JSON.parse(localStorage.getItem('user_context')) || {'lang': 'en_US'};\n  private headers: HttpHeaders;\n  private http_auth: string;\n  private odoo_server: string;\n\n  constructor(\n    @Inject(HttpClient) private http: HttpClient) {\n    this.cookies = new Cookies();\n  }\n\n  public init(configs: any) {\n    this.odoo_server = configs.odoo_server;\n    this.http_auth = configs.http_auth || null;\n  }\n\n  public setOdooServer(odoo_server: string) {\n    this.odoo_server = odoo_server;\n  }\n\n  public setHttpAuth(http_auth: string) {\n    this.http_auth = http_auth;\n  }\n\n  public sendRequest(url: string, params: Object): Promise<any> {\n    const body = this.buildRequest(url, params);\n    return this.http.post(this.odoo_server + url, body, {headers: this.headers})\n      .toPromise()\n      .then(this.handleOdooErrors)\n      .catch(this.handleHttpErrors);\n  }\n\n  public getServerInfo() {\n    return this.sendRequest('/web/webclient/version_info', {});\n  }\n\n  public getSessionInfo() {\n    return this.sendRequest('/web/session/get_session_info', {});\n  }\n\n  public login(db: string, login: string, password: string) {\n    const params = {\n      db: db,\n      login: login,\n      password: password\n    };\n    const $this = this;\n    return this.sendRequest('/web/session/authenticate', params).then(function (result: any) {\n      if (!result.uid) {\n        $this.cookies.delete_sessionId();\n        return Promise.reject({\n          title: 'wrong_login',\n          message: 'Username and password don\\'t match',\n          fullTrace: result\n        });\n      }\n      $this.context = result.user_context;\n      localStorage.setItem('user_context', JSON.stringify($this.context));\n      $this.cookies.set_sessionId(result.session_id);\n      return result;\n    });\n  }\n\n  public isLoggedIn(force: boolean = true) {\n    if (!force) {\n      return Promise.resolve(this.cookies.get_sessionId().length > 0);\n    }\n    return this.getSessionInfo().then((result: any) => {\n      this.cookies.set_sessionId(result.session_id);\n      return !!(result.uid);\n    });\n  }\n\n  public logout(force: boolean = true) {\n    this.cookies.delete_sessionId();\n    if (force) {\n      return this.getSessionInfo().then((r: any) => { // get db from sessionInfo\n        if (r.db) {\n          return this.login(r.db, '', '');\n        }\n      });\n    } else {\n      return Promise.resolve();\n    }\n  }\n\n  public getDbList() { // only use for odoo < 9.0\n    return this.sendRequest('/web/database/get_list', {});\n  }\n\n  public searchRead(model: string, domain: any, fields: any, limit: number, offset: number, context: any = {}, sort?: string) {\n    const params = {\n      model: model,\n      domain: domain,\n      fields: fields,\n      limit: limit,\n      offset: offset,\n      context: context || this.context,\n      sort: sort || ''\n    };\n    return this.sendRequest('/web/dataset/search_read', params);\n  }\n\n  public updateContext(context: any) {\n    localStorage.setItem('user_context', JSON.stringify(context));\n    const args = [[(<any>this.context).uid], context];\n    this.call('res.users', 'write', args, {})\n      .then(() => this.context = context)\n      .catch((err: any) => this.context = context);\n  }\n\n  public getContext() {\n    return this.context;\n  }\n\n  public getServer() {\n    return this.odoo_server;\n  }\n\n  public call(model: string, method: string, args: any, kwargs: any) {\n\n    kwargs = kwargs || {};\n    kwargs.context = kwargs.context || {};\n    (<any>Object).assign(kwargs.context, this.context);\n\n    const params = {\n      model: model,\n      method: method,\n      args: args,\n      kwargs: kwargs,\n    };\n    return this.sendRequest('/web/dataset/call_kw', params);\n  }\n\n  private buildRequest(url: string, params: any) {\n    this.uniq_id_counter += 1;\n    if (this.shouldManageSessionId) {\n      params.session_id = this.cookies.get_sessionId();\n    }\n\n    this.headers = new HttpHeaders({\n      'Content-Type': 'application/json',\n      'X-Openerp-Session-Id': this.cookies.get_sessionId(),\n      'Authorization': 'Basic ' + btoa(`${this.http_auth}`)\n    });\n    return JSON.stringify({\n      jsonrpc: '2.0',\n      method: 'call',\n      params: params, // payload\n    });\n  }\n\n  private handleOdooErrors(response: any) {\n    if (!response.error) {\n      return response.result;\n    }\n\n    const error = response.error;\n    const errorObj = {\n      title: '    ',\n      message: '',\n      fullTrace: error\n    };\n\n    if (error.code === 200 && error.message === 'Odoo Server Error' && error.data.name === 'werkzeug.exceptions.NotFound') {\n      errorObj.title = 'page_not_found';\n      errorObj.message = 'HTTP Error';\n    } else if ((error.code === 100 && error.message === 'Odoo Session Expired') || // v8\n      (error.code === 300 && error.message === 'OpenERP WebClient Error' && error.data.debug.match('SessionExpiredException')) // v7\n    ) {\n      errorObj.title = 'session_expired';\n      this.cookies.delete_sessionId();\n    } else if ((error.message === 'Odoo Server Error' && /FATAL:  database \"(.+)\" does not exist/.test(error.data.message))) {\n      errorObj.title = 'database_not_found';\n      errorObj.message = error.data.message;\n    } else if ((error.data.name === 'openerp.exceptions.AccessError')) {\n      errorObj.title = 'AccessError';\n      errorObj.message = error.data.message;\n    } else {\n      const split = ('' + error.data.fault_code).split('\\n')[0].split(' -- ');\n      if (split.length > 1) {\n        error.type = split.shift();\n        error.data.fault_code = error.data.fault_code.substr(error.type.length + 4);\n      }\n\n      if (error.code === 200 && error.type) {\n        errorObj.title = error.type;\n        errorObj.message = error.data.fault_code.replace(/\\n/g, '<br />');\n      } else {\n        errorObj.title = error.message;\n        errorObj.message = error.data.debug.replace(/\\n/g, '<br />');\n      }\n    }\n    return Promise.reject(errorObj);\n  }\n\n  private handleHttpErrors(error: any) {\n    return Promise.reject(error.message || error);\n  }\n\n}\n","import { NgModule } from '@angular/core';\n\n@NgModule({\n  imports: [\n  ],\n})\nexport class Angular6OdooJsonrpcModule { }\n"],"names":["HttpHeaders","Injectable","HttpClient","Inject","NgModule"],"mappings":"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"}
